generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ──────────────────────────────────────────────────

enum TransactionType {
  debt
  payment
}

enum ReminderChannel {
  whatsapp
  sms
}

enum ReminderStatus {
  pending
  sent
  failed
  read
}

enum Language {
  su
  ff
  man
  fr
}

// ─── Core Models ────────────────────────────────────────────

model Retailer {
  id           String    @id @default(uuid())
  phone        String    @unique
  language     Language  @default(fr)
  shopName     String?
  neighborhood String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  customers    Customer[]
  transactions Transaction[]
  reminders    Reminder[]
  sessions     Session[]
}

model Customer {
  id           String    @id @default(uuid())
  retailerId   String
  name         String
  phone        String?
  colorCode    String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  deletedAt    DateTime?

  // Sync fields
  syncStatus   String    @default("synced")
  lastSyncedAt DateTime?
  clientId     String?

  retailer     Retailer      @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  transactions Transaction[]
  reminders    Reminder[]

  @@index([retailerId])
  @@index([deletedAt])
  @@index([syncStatus])
}

model Transaction {
  id           String          @id @default(uuid())
  retailerId   String
  customerId   String
  type         TransactionType
  amount       Int             // GNF, no decimals
  note         String?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt

  // Sync fields
  syncStatus   String          @default("synced")
  lastSyncedAt DateTime?
  clientId     String?

  retailer     Retailer          @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  customer     Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade)
  items        TransactionItem[]

  @@index([retailerId])
  @@index([customerId])
  @@index([createdAt])
  @@index([syncStatus])
}

model TransactionItem {
  id            String @id @default(uuid())
  transactionId String
  description   String
  amount        Int    // GNF

  transaction Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  @@index([transactionId])
}

// ─── Engagement ─────────────────────────────────────────────

model Reminder {
  id           String          @id @default(uuid())
  retailerId   String
  customerId   String
  message      String
  channel      ReminderChannel @default(whatsapp)
  language     Language        @default(fr)
  status       ReminderStatus  @default(pending)
  scheduledAt  DateTime?
  sentAt       DateTime?
  createdAt    DateTime        @default(now())

  retailer Retailer @relation(fields: [retailerId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([retailerId])
  @@index([customerId])
  @@index([status])
}

// ─── Auth ───────────────────────────────────────────────────

model Session {
  id         String   @id @default(uuid())
  retailerId String
  token      String   @unique
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  retailer Retailer @relation(fields: [retailerId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([retailerId])
  @@index([expiresAt])
}

model OtpVerification {
  id        String   @id @default(uuid())
  phone     String
  code      String
  expiresAt DateTime
  verified  Boolean  @default(false)
  attempts  Int      @default(0)
  createdAt DateTime @default(now())

  @@index([phone, code])
  @@index([expiresAt])
}
